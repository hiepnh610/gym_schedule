<template>
  <div id="workouts-page" v-if="!isLoading">
    <div class="text-center">
      <div class="page-title">
        <div class="container">
          <h2 class="text-center mb-5">{{ planName }}</h2>
        </div>
      </div>

      <list-workouts v-if="listWorkouts && listWorkouts.length > 0"></list-workouts>

      <p class="align-center mt-5 mb-5" v-if="listWorkouts.length === 0">Please create a workout day from the under button.</p>

      <a href="" class="btn btn-lg btn-primary" @click.prevent="createWorkout" v-if="displayBtn">
        Create Workout Day
      </a>

      <workout-create></workout-create>
    </div>
  </div>

  <loading v-else />
</template>

<script lang="ts">
import { Component, Prop, Vue } from 'vue-property-decorator'
import { State, Action, Getter } from 'vuex-class'
import { FontAwesomeIcon } from '@fortawesome/vue-fontawesome'
import axios from 'axios'

import config from '@/config'
import { Response, ID, setLoading } from '@/util'

import workoutCreate from '@/components/workout/workout-create.vue'
import listWorkouts from '@/components/workout/list-workouts.vue'
import Loading from '@/components/loading/loading.vue'

const namespaceModal: string = 'modal'
const namespaceWorkouts: string = 'workouts'

@Component({
  components: {
  workoutCreate,
  listWorkouts,
  FontAwesomeIcon,
  Loading,
  },
  })
export default class Workouts extends Vue {
  @Prop() id!: string

  @Action('setShowModalBackdrop', { namespace: namespaceModal }) setShowModalBackdrop: any
  @Action('setShowCreateModal', { namespace: namespaceModal }) setShowCreateModal: any

  @Action('setListWorkouts', { namespace: namespaceWorkouts }) setListWorkouts: any
  @Getter('listWorkouts', { namespace: namespaceWorkouts }) listWorkouts: any

  planName: string = ''
  planFrequency: string = ''
  message: string = ''
  isLoading: boolean = true

  createWorkout () {
    this.setShowModalBackdrop(true)
    this.setShowCreateModal(true)
  }

  created () {
    const params: ID = {
      id: this.id
    }

    axios
      .get(config.api.workout, { params })
      .then(function (response: Response) {
        this.setListWorkouts(response.data)

        setLoading(this, false)
      }.bind(this))
      .catch(function (error: Response) {
        if (error.response && error.response.data && error.response.data.message) {
          this.message = error.response.data.message
        } else {
          this.message = 'Error happened.'
        }
      }.bind(this))

    axios
      .get(config.api.listPlans, {
        params: {
          id: this.id
        }
      })
      .then(function (response: Response) {
        this.planName = response.data[0].name
        this.planFrequency = response.data[0].frequency
      }.bind(this))
      .catch(function (error: Response) {
        if (error.response && error.response.data && error.response.data.message) {
          this.message = error.response.data.message
        } else {
          this.message = 'Error happened.'
        }
      }.bind(this))
  }

  get displayBtn () {
    if (this.listWorkouts.length < this.planFrequency) {
      return true
    }
  }
}
</script>
